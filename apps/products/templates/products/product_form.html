{% extends 'layout.html' %}
{% load custom_filters %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <!-- Formulario -->
        <div class="col-12 col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h5><i class="fas fa-box"></i> {% if object %}Editar{% else %} Nuevo{% endif %} Producto</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-12 col-lg-8">
                                <div class="row">
                                    <div class="col-sm-6 col-md-4 mb-3">
                                        <label for="{{ form.barcode.id_for_label }}" class="form-label">Código de Barras</label>
                                        {{ form.barcode|add_class:"form-control" }}
                                    </div>
                                    <div class="col-sm-6 col-md-5 mb-3">
                                        <label for="{{ form.idMarca.id_for_label }}" class="form-label">Marca</label>
                                        {{ form.idMarca|add_class:"form-control" }}
                                    </div>
                                    <div class="col-sm-6 col-md-3 mb-3">
                                        <label for="{{ form.idUnit.id_for_label }}" class="form-label">Unidades</label>
                                        {{ form.idUnit|add_class:"form-control" }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.idCategory.id_for_label }}" class="form-label">Categoría</label>
                                    {{ form.idCategory|add_class:"form-control" }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.product.idProduct_for_label }}" class="form-label">Nombre del Producto</label>
                                    {{ form.product|add_class:"form-control" }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.imagen.id_for_label }}" class="form-label">Imagen del Producto</label>
                                    <input type="file" id="imagen" name="imagen" class="form-control" onchange="previewImage(event)">
                                </div>
                            </div>
                            <div class="col-12 col-lg-4 text-center">
                                <h5>Vista Previa</h5>
                                <img id="preview" class="img-fluid rounded shadow-sm" 
                                     src="{% if object and object.imagen %}{{ object.imagen.url }}{% else %}{% static 'images/0Product.jpg' %}{% endif %}" 
                                     alt="Imagen del producto" style="max-width: 100%; height: auto;">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <a href="{% url 'products:products_list' %}" class="btn btn-secondary w-100">
                                    <i class="fas fa-arrow-left"></i> Cancelar
                                </a>
                            </div>
                            <div class="col-6">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function previewImage(event) {
            var output = document.getElementById('preview');
            var file = event.target.files[0];
            if (file) {
                output.src = URL.createObjectURL(file);
            } else {
                output.src = "{% static 'images/0Product.jpg' %}";
            }
        }

        document.getElementById('{{ form.product.idProduct_for_label }}').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        var imagenInput = document.getElementById('imagen');
        if (imagenInput) {
            imagenInput.addEventListener('change', previewImage);
            if (imagenInput.files.length > 0) {
                previewImage({ target: imagenInput });
            }
        }
    });
</script>
{% endblock %}
