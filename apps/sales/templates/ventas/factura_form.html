{% extends 'layout.html' %}
{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Factura</h2>
    <form method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_cliente" class="form-label">Cliente</label>
                    {{ form.cliente }}
                </div>
                <div class="mb-3">
                    <label for="id_usuario" class="form-label">Vendedor</label>
                    {{ form.usuario }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_total" class="form-label">Total</label>
                    {{ form.total }}
                </div>
                <div class="mb-3">
                    <label for="id_consecutivo" class="form-label">Número de Factura</label>
                    {{ form.consecutivo }}
                </div>
                <div class="mb-3">
                    <label for="id_codigo_autorizacion" class="form-label">Código de Autorización</label>
                    {{ form.codigo_autorizacion }}
                </div>
                <div class="mb-3">
                    <label for="id_fecha_autorizacion" class="form-label">Fecha de Autorización</label>
                    {{ form.fecha_autorizacion }}
                </div>
            </div>
        </div>
        
        <h4>Detalle de Factura</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Artículo</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="detalle-factura">
                {% for detalle in detalle_formset %}
                <tr>
                    <td>{{ detalle.articulo }}</td>
                    <td>{{ detalle.cantidad }}</td>
                    <td>{{ detalle.precio }}</td>
                    <td class="subtotal">0.00</td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-detalle">Eliminar</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <button type="submit" class="btn btn-success">Guardar Factura</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        function actualizarTotales() {
            let total = 0;
            document.querySelectorAll("#detalle-factura tr").forEach(function (row) {
                let cantidad = row.querySelector("input[name$='cantidad']").value || 0;
                let precio = row.querySelector("input[name$='precio']").value || 0;
                let subtotal = cantidad * precio;
                row.querySelector(".subtotal").textContent = subtotal.toFixed(2);
                total += subtotal;
            });
            document.querySelector("#id_total").value = total.toFixed(2);
        }
        
        document.querySelector("#detalle-factura").addEventListener("input", actualizarTotales);
        document.querySelectorAll(".remove-detalle").forEach(button => {
            button.addEventListener("click", function () {
                this.closest("tr").remove();
                actualizarTotales();
            });
        });
    });
</script>
{% endblock %}
